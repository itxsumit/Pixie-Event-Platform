<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pixie Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-slate-50 font-sans text-slate-900">
    <div class="flex min-h-screen">
        <aside class="w-64 bg-slate-900 text-white hidden md:block">
            <div class="p-6 border-b border-slate-800">
                <h2 class="text-2xl font-bold text-blue-400">Pixie <span class="text-white">Event</span></h2>
            </div>
            <nav class="mt-6 px-4">
                <a href="#" class="flex items-center p-3 bg-blue-600 rounded-lg mb-2 shadow-lg shadow-blue-500/20"><i class="fas fa-chart-line mr-3"></i> Dashboard</a>
                <a href="https://docs.google.com/spreadsheets/d/18SKzL9bPAiOQyiFwwshtv93ekTjp9h2CfyoTfwA3VSA/edit#gid=0" 
                   target="_blank" class="flex items-center p-3 hover:bg-slate-800 rounded-lg text-slate-400 transition">
                    <i class="fas fa-file-excel mr-3"></i> Google Sheet
                </a>
            </nav>
        </aside>

        <main class="flex-1 p-8 overflow-y-auto">
            <header class="flex justify-between items-center mb-10">
                <div><h1 class="text-3xl font-extrabold tracking-tight">Analytics Overview</h1><p class="text-slate-500">New Sheet Active Monitoring</p></div>
                <div class="flex items-center space-x-2 bg-white p-2 rounded-xl shadow-sm border border-slate-200">
                    <input id="cityInput" type="text" placeholder="Enter city (e.g. delhi)" class="px-4 py-1 outline-none text-sm w-44">
                    <button onclick="changeLocation()" class="bg-blue-600 text-white px-5 py-1 rounded-lg text-sm font-bold hover:bg-blue-700 transition">Update</button>
                </div>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-10">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200"><h3 class="text-slate-500 font-semibold uppercase text-xs">Total Events</h3><p id="totalCount" class="text-4xl font-black mt-1">--</p></div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200"><h3 class="text-slate-500 font-semibold uppercase text-xs">Primary City</h3><p id="cityDisplay" class="text-4xl font-black mt-1 text-blue-600">jaipur</p></div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200"><h3 class="text-slate-500 font-semibold uppercase text-xs">Sync Status</h3><p class="text-4xl font-black mt-1 text-green-600">Active</p></div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-6 border-b bg-slate-50 font-bold">Recent Data (MySQL)</div>
                    <div class="overflow-x-auto h-[450px]"><table class="w-full text-left border-collapse"><tbody id="eventTableBody"></tbody></table></div>
                </div>
                <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-200 flex flex-col items-center">
                    <h3 class="font-bold text-lg mb-6 text-center">Venue Distribution</h3>
                    <div class="h-[350px] w-full flex justify-center"><canvas id="venueChart"></canvas></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let myChart = null;
        function fetchData() {
            fetch('/api/events').then(res => res.json()).then(data => {
                document.getElementById('totalCount').innerText = data.length;
                const tableBody = document.getElementById('eventTableBody');
                tableBody.innerHTML = '';
                const venueCounts = {};
                data.forEach(event => {
                    const venue = (event.venue || 'Jaipur').split(',')[0];
                    venueCounts[venue] = (venueCounts[venue] || 0) + 1;
                    tableBody.innerHTML += `<tr class="border-b hover:bg-slate-50 transition group"><td class="px-6 py-4"><div class="font-semibold text-sm text-slate-800">${event.title}</div><div class="text-[10px] text-slate-400 truncate max-w-[250px]">${event.eventUrl}</div></td><td class="px-6 py-4 text-right text-[10px] font-bold uppercase text-slate-500">${venue}</td></tr>`;
                });
                if(myChart) myChart.destroy();
                myChart = new Chart(document.getElementById('venueChart'), {
                    type: 'doughnut',
                    data: { labels: Object.keys(venueCounts), datasets: [{ data: Object.values(venueCounts), backgroundColor: ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444'], borderWidth: 0 }] },
                    options: { cutout: '70%', responsive: true, maintainAspectRatio: false }
                });
            });
            fetch('/api/status').then(res => res.json()).then(status => { document.getElementById('cityDisplay').innerText = status.city; });
        }
        function changeLocation() {
            const city = document.getElementById('cityInput').value;
            fetch('/api/update-location?city=' + city, { method: 'POST' }).then(res => res.json()).then(data => { alert(data.message); location.reload(); });
        }
        window.onload = fetchData;
    </script>
</body>
</html>